{% extends "base.html" %}

{% block title %}Transactions - Grocery Store Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="fas fa-receipt me-2"></i>Transaction Management</h2>
    </div>
</div>

<!-- Filters -->
<div class="row g-3 mb-4">
    <div class="col-md-3">
        <label class="form-label">Start Date</label>
        <input type="date" class="form-control" id="startDate">
    </div>
    <div class="col-md-3">
        <label class="form-label">End Date</label>
        <input type="date" class="form-control" id="endDate">
    </div>
    <div class="col-md-2">
        <label class="form-label">&nbsp;</label>
        <button class="btn btn-primary w-100" onclick="loadTransactions()">
            <i class="fas fa-filter me-1"></i> Filter
        </button>
    </div>
    <div class="col-md-2">
        <label class="form-label">&nbsp;</label>
        <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
            <i class="fas fa-redo me-1"></i> Reset
        </button>
    </div>
    <div class="col-md-2">
        <label class="form-label">&nbsp;</label>
        <div class="d-flex gap-2">
            <button class="btn btn-success" onclick="exportToExcel()" title="Export to Excel">
                <i class="fas fa-file-excel"></i>
            </button>
        </div>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title">Total Transactions</h6>
                <h3 id="totalTransactions">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">Total Sales</h6>
                <h3 id="totalSales">₹0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title">Average Transaction</h6>
                <h3 id="avgTransaction">₹0</h3>
            </div>
        </div>
    </div>
</div>

<!-- Transactions Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="transactionsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Invoice No.</th>
                        <th>Date</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Payment</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="8" class="text-center text-muted">Loading transactions...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- View Sale Details Modal -->
<div class="modal fade" id="saleDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sale Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="saleDetailsContent">
                <!-- Sale details will be loaded here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="printInvoice()">
                    <i class="fas fa-print me-1"></i> Print
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let allTransactions = [];
let currentSaleId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Set default date range to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
    
    loadTransactions();
});

async function loadTransactions() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    try {
        let url = '/api/sales?';
        if (startDate) url += `start_date=${startDate}&`;
        if (endDate) url += `end_date=${endDate}`;
        
        const response = await fetch(url);
        const transactions = await response.json();
        
        allTransactions = transactions;
        renderTransactions(transactions);
        updateSummary(transactions);
    } catch (error) {
        console.error('Error loading transactions:', error);
    }
}

function renderTransactions(data) {
    const tbody = document.querySelector('#transactionsTable tbody');
    
    if (data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No transactions found</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(t => `
        <tr>
            <td>${t.sale_id}</td>
            <td><strong>${t.invoice_number}</strong></td>
            <td>${new Date(t.sale_date).toLocaleString()}</td>
            <td>${t.customer_name || 'Walk-in'}</td>
            <td>₹${parseFloat(t.total_amount).toFixed(2)}</td>
            <td>
                <span class="badge bg-${getPaymentBadgeColor(t.payment_method)}">
                    ${t.payment_method}
                </span>
            </td>
            <td>
                <span class="badge bg-${t.status === 'Completed' ? 'success' : t.status === 'Refunded' ? 'warning' : 'danger'}">
                    ${t.status}
                </span>
            </td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="viewSaleDetails(${t.sale_id})" title="View Details">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function getPaymentBadgeColor(method) {
    switch(method) {
        case 'Cash': return 'success';
        case 'UPI': return 'info';
        case 'Card': return 'warning';
        default: return 'secondary';
    }
}

function updateSummary(data) {
    const total = data.length;
    const totalAmount = data.reduce((sum, t) => sum + parseFloat(t.total_amount), 0);
    const avg = total > 0 ? totalAmount / total : 0;
    
    document.getElementById('totalTransactions').textContent = total;
    document.getElementById('totalSales').textContent = '₹' + totalAmount.toFixed(2);
    document.getElementById('avgTransaction').textContent = '₹' + avg.toFixed(2);
}

async function viewSaleDetails(saleId) {
    currentSaleId = saleId;
    
    try {
        const response = await fetch(`/api/sales/${saleId}`);
        const sale = await response.json();
        
        const content = document.getElementById('saleDetailsContent');
        
        let itemsHtml = sale.items.map(item => `
            <tr>
                <td>${item.product_name}</td>
                <td>${item.quantity}</td>
                <td>₹${parseFloat(item.unit_price).toFixed(2)}</td>
                <td>₹${parseFloat(item.total_price).toFixed(2)}</td>
            </tr>
        `).join('');
        
        content.innerHTML = `
            <div class="row mb-3">
                <div class="col-md-6">
                    <p><strong>Invoice:</strong> ${sale.invoice_number}</p>
                    <p><strong>Date:</strong> ${new Date(sale.sale_date).toLocaleString()}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Customer:</strong> ${sale.customer_name || 'Walk-in Customer'}</p>
                    <p><strong>Payment:</strong> ${sale.payment_method}</p>
                </div>
            </div>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsHtml}
                </tbody>
            </table>
            <div class="text-end">
                <p>Subtotal: ₹${parseFloat(sale.subtotal).toFixed(2)}</p>
                <p>Discount: -₹${parseFloat(sale.discount_amount).toFixed(2)}</p>
                <p>Tax: ₹${parseFloat(sale.tax_amount).toFixed(2)}</p>
                <h4>Total: ₹${parseFloat(sale.total_amount).toFixed(2)}</h4>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('saleDetailsModal')).show();
    } catch (error) {
        console.error('Error loading sale details:', error);
    }
}

function printInvoice() {
    window.print();
}

function resetFilters() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = today;
    loadTransactions();
}

function exportToExcel() {
    if (allTransactions.length === 0) {
        alert('No data to export');
        return;
    }
    
    let csv = 'ID,Invoice No,Date,Customer,Amount,Payment,Status\n';
    
    allTransactions.forEach(t => {
        csv += `${t.sale_id},"${t.invoice_number}","${new Date(t.sale_date).toLocaleString()}","${t.customer_name || 'Walk-in'}",${t.total_amount},${t.payment_method},${t.status}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `transactions_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
