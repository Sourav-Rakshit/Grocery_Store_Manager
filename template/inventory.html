{% extends "base.html" %}

{% block title %}Inventory - Grocery Store Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="fas fa-boxes me-2"></i>Inventory Management</h2>
    </div>
</div>

<!-- Search and Filter -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="searchProduct" placeholder="Search products...">
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="categoryFilter">
            <option value="">All Categories</option>
        </select>
    </div>
    <div class="col-md-3">
        <div class="form-check mt-2">
            <input class="form-check-input" type="checkbox" id="lowStockOnly">
            <label class="form-check-label" for="lowStockOnly">Low Stock Only</label>
        </div>
    </div>
    <div class="col-md-2">
        <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#productModal">
            <i class="fas fa-plus me-1"></i> Add Product
        </button>
    </div>
</div>

<!-- Products Table -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="productsTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Product Name</th>
                        <th>Category</th>
                        <th>Barcode</th>
                        <th>Price</th>
                        <th>Cost</th>
                        <th>Stock</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td colspan="9" class="text-center text-muted">Loading products...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="productModalTitle">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="productForm">
                <div class="modal-body">
                    <input type="hidden" id="productId">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Product Name *</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Category</label>
                            <select class="form-select" id="productCategory">
                                <option value="">Select Category</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Barcode</label>
                            <input type="text" class="form-control" id="productBarcode">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Selling Price *</label>
                            <input type="number" step="0.01" class="form-control" id="productPrice" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Cost Price</label>
                            <input type="number" step="0.01" class="form-control" id="productCostPrice">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="productQuantity" value="0">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Low Stock Threshold</label>
                            <input type="number" class="form-control" id="productThreshold" value="10">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Expiry Date</label>
                            <input type="date" class="form-control" id="productExpiry">
                        </div>
                        <div class="col-12">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" id="productDescription" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Product</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this product? This action cannot be undone.</p>
                <input type="hidden" id="deleteProductId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let categories = [];

document.addEventListener('DOMContentLoaded', function() {
    loadCategories();
    loadProducts();
    
    document.getElementById('searchProduct').addEventListener('input', debounce(loadProducts, 300));
    document.getElementById('categoryFilter').addEventListener('change', loadProducts);
    document.getElementById('productForm').addEventListener('submit', saveProduct);
    document.getElementById('confirmDelete').addEventListener('click', deleteProduct);
    
    document.getElementById('productModal').addEventListener('hidden.bs.modal', resetProductForm);
});

async function loadCategories() {
    try {
        const response = await fetch('/api/categories');
        categories = await response.json();
        
        const categoryOptions = categories.map(c => `<option value="${c.category_id}">${c.category_name}</option>`).join('');
        document.getElementById('categoryFilter').innerHTML = '<option value="">All Categories</option>' + categoryOptions;
        document.getElementById('productCategory').innerHTML = '<option value="">Select Category</option>' + categoryOptions;
    } catch (error) {
        console.error('Error loading categories:', error);
    }
}

async function loadProducts() {
    try {
        const search = document.getElementById('searchProduct').value;
        const categoryId = document.getElementById('categoryFilter').value;
        
        let url = '/api/products?';
        if (search) url += `search=${encodeURIComponent(search)}&`;
        if (categoryId) url += `category_id=${categoryId}`;
        
        const response = await fetch(url);
        let products = await response.json();
        
        // Filter low stock if checkbox is checked
        if (document.getElementById('lowStockOnly').checked) {
            products = products.filter(p => p.quantity <= p.low_stock_threshold);
        }
        
        renderProducts(products);
    } catch (error) {
        console.error('Error loading products:', error);
    }
}

function renderProducts(products) {
    const tbody = document.querySelector('#productsTable tbody');
    
    if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9" class="text-center text-muted">No products found</td></tr>';
        return;
    }
    
    tbody.innerHTML = products.map(p => {
        const isLowStock = p.quantity <= p.low_stock_threshold;
        return `
            <tr>
                <td>${p.product_id}</td>
                <td><strong>${p.product_name}</strong></td>
                <td>${p.category_name || '-'}</td>
                <td>${p.barcode || '-'}</td>
                <td>₹${parseFloat(p.price).toFixed(2)}</td>
                <td>₹${parseFloat(p.cost_price || 0).toFixed(2)}</td>
                <td>
                    <span class="badge ${isLowStock ? 'bg-danger' : 'bg-success'}">
                        ${p.quantity}
                    </span>
                </td>
                <td>${isLowStock ? '<span class="badge bg-warning">Low Stock</span>' : '<span class="badge bg-success">In Stock</span>'}</td>
                <td>
                    <button class="btn btn-sm btn-primary" onclick="editProduct(${p.product_id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="confirmDelete(${p.product_id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    }).join('');
}

function editProduct(productId) {
    fetch(`/api/products`)
        .then(res => res.json())
        .then(products => {
            const product = products.find(p => p.product_id === productId);
            if (product) {
                document.getElementById('productId').value = product.product_id;
                document.getElementById('productName').value = product.product_name;
                document.getElementById('productCategory').value = product.category_id || '';
                document.getElementById('productBarcode').value = product.barcode || '';
                document.getElementById('productPrice').value = product.price;
                document.getElementById('productCostPrice').value = product.cost_price || '';
                document.getElementById('productQuantity').value = product.quantity;
                document.getElementById('productThreshold').value = product.low_stock_threshold;
                document.getElementById('productExpiry').value = product.expiry_date || '';
                document.getElementById('productDescription').value = product.description || '';
                
                document.getElementById('productModalTitle').textContent = 'Edit Product';
                new bootstrap.Modal(document.getElementById('productModal')).show();
            }
        });
}

function confirmDelete(productId) {
    document.getElementById('deleteProductId').value = productId;
    new bootstrap.Modal(document.getElementById('deleteModal')).show();
}

async function deleteProduct() {
    const productId = document.getElementById('deleteProductId').value;
    
    try {
        const response = await fetch(`/api/products/${productId}`, { method: 'DELETE' });
        const data = await response.json();
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
            loadProducts();
            showToast('Product deleted successfully', 'success');
        } else {
            showToast(data.error || 'Error deleting product', 'error');
        }
    } catch (error) {
        showToast('Error deleting product', 'error');
    }
}

async function saveProduct(e) {
    e.preventDefault();
    
    const productId = document.getElementById('productId').value;
    const productData = {
        product_name: document.getElementById('productName').value,
        category_id: document.getElementById('productCategory').value || null,
        barcode: document.getElementById('productBarcode').value,
        price: parseFloat(document.getElementById('productPrice').value),
        cost_price: parseFloat(document.getElementById('productCostPrice').value) || 0,
        quantity: parseInt(document.getElementById('productQuantity').value) || 0,
        low_stock_threshold: parseInt(document.getElementById('productThreshold').value) || 10,
        expiry_date: document.getElementById('productExpiry').value || null,
        description: document.getElementById('productDescription').value
    };
    
    try {
        const url = productId ? `/api/products/${productId}` : '/api/products';
        const method = productId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(productData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
            loadProducts();
            showToast('Product saved successfully', 'success');
        } else {
            showToast(data.error || 'Error saving product', 'error');
        }
    } catch (error) {
        showToast('Error saving product', 'error');
    }
}

function resetProductForm() {
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('productModalTitle').textContent = 'Add New Product';
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.appendChild(toast);
    document.body.appendChild(container);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => container.remove());
}
</script>
{% endblock %}
