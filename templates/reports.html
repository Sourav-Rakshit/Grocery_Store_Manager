{% extends "base.html" %}

{% block title %}Reports - Grocery Store Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="fas fa-chart-bar me-2"></i>Sales Reports & Dashboard</h2>
    </div>
</div>

<!-- Report Type Selection -->
<div class="row g-3 mb-4">
    <div class="col-md-12">
        <div class="btn-group" role="group">
            <input type="radio" class="btn-check" name="reportType" id="daily" value="daily" checked>
            <label class="btn btn-outline-primary" for="daily">Daily</label>
            
            <input type="radio" class="btn-check" name="reportType" id="monthly" value="monthly">
            <label class="btn btn-outline-primary" for="monthly">Monthly</label>
            
            <input type="radio" class="btn-check" name="reportType" id="yearly" value="yearly">
            <label class="btn btn-outline-primary" for="yearly">Yearly</label>
        </div>
        <button class="btn btn-success ms-3" onclick="exportReport()">
            <i class="fas fa-download me-1"></i> Export Report
        </button>
    </div>
</div>

<!-- Summary Cards -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title">Today's Sales</h6>
                <h3 id="todaySales">₹0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <h6 class="card-title">Monthly Sales</h6>
                <h3 id="monthlySales">₹0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-dark">
            <div class="card-body">
                <h6 class="card-title">Transactions Today</h6>
                <h3 id="todayTransactions">0</h3>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <h6 class="card-title">Total Products</h6>
                <h3 id="totalProducts">0</h3>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4 mb-4">
    <div class="col-md-8">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Sales Trend</h5>
            </div>
            <div class="card-body">
                <canvas id="salesTrendChart"></canvas>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-header">
                <h5 class="mb-0">Payment Methods</h5>
            </div>
            <div class="card-body">
                <canvas id="paymentChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Top Products & Low Stock -->
<div class="row g-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Top Selling Products</h5>
            </div>
            <div class="card-body">
                <div id="topProductsList">
                    <p class="text-muted text-center">Loading...</p>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">Low Stock Products</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm" id="lowStockTable">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Stock</th>
                                <th>Threshold</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="3" class="text-center text-muted">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let salesTrendChart = null;
let paymentChart = null;
let reportData = [];

document.addEventListener('DOMContentLoaded', function() {
    loadReportData();
    
    document.querySelectorAll('input[name="reportType"]').forEach(radio => {
        radio.addEventListener('change', loadReportData);
    });
});

async function loadReportData() {
    try {
        const [statsResponse, chartResponse] = await Promise.all([
            fetch('/api/dashboard/stats'),
            fetch('/api/reports/chart-data')
        ]);
        
        const stats = await statsResponse.json();
        const chartData = await chartResponse.json();
        
        // Update summary cards
        document.getElementById('todaySales').textContent = '₹' + stats.today_sales.toFixed(2);
        document.getElementById('monthlySales').textContent = '₹' + stats.monthly_sales.toFixed(2);
        document.getElementById('todayTransactions').textContent = stats.today_transactions;
        document.getElementById('totalProducts').textContent = stats.total_products;
        
        // Update low stock table
        const lowStockBody = document.querySelector('#lowStockTable tbody');
        if (stats.low_stock_products && stats.low_stock_products.length > 0) {
            lowStockBody.innerHTML = stats.low_stock_products.map(p => `
                <tr>
                    <td>${p.product_name}</td>
                    <td><span class="badge bg-danger">${p.quantity}</span></td>
                    <td>${p.low_stock_threshold}</td>
                </tr>
            `).join('');
        } else {
            lowStockBody.innerHTML = '<tr><td colspan="3" class="text-center text-success">All products well stocked</td></tr>';
        }
        
        // Update top products
        const topProductsDiv = document.getElementById('topProductsList');
        if (stats.top_products && stats.top_products.length > 0) {
            topProductsDiv.innerHTML = '<ul class="list-group list-group-flush">' + 
                stats.top_products.map((p, i) => `
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        <span><strong>${i+1}.</strong> ${p.product_name}</span>
                        <div>
                            <span class="badge bg-primary me-2">${p.total_sold} sold</span>
                            <span class="badge bg-success">₹${p.total_revenue.toFixed(2)}</span>
                        </div>
                    </li>
                `).join('') + '</ul>';
        } else {
            topProductsDiv.innerHTML = '<p class="text-muted text-center">No sales data yet</p>';
        }
        
        // Render charts
        renderSalesTrendChart(chartData.weekly);
        renderPaymentChart();
        
    } catch (error) {
        console.error('Error loading report data:', error);
    }
}

function renderSalesTrendChart(data) {
    const ctx = document.getElementById('salesTrendChart').getContext('2d');
    
    if (salesTrendChart) salesTrendChart.destroy();
    
    salesTrendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => new Date(d.date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' })),
            datasets: [{
                label: 'Sales (₹)',
                data: data.map(d => d.sales),
                borderColor: 'rgb(54, 162, 235)',
                backgroundColor: 'rgba(54, 162, 235, 0.1)',
                fill: true,
                tension: 0.4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { display: false }
            },
            scales: {
                y: { 
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return '₹' + value;
                        }
                    }
                }
            }
        }
    });
}

function renderPaymentChart() {
    const ctx = document.getElementById('paymentChart').getContext('2d');
    
    if (paymentChart) paymentChart.destroy();
    
    paymentChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Cash', 'UPI', 'Card'],
            datasets: [{
                data: [45, 35, 20],
                backgroundColor: [
                    'rgba(75, 192, 192, 0.6)',
                    'rgba(54, 162, 235, 0.6)',
                    'rgba(255, 206, 86, 0.6)'
                ],
                borderColor: [
                    'rgb(75, 192, 192)',
                    'rgb(54, 162, 235)',
                    'rgb(255, 206, 86)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'bottom' }
            }
        }
    });
}

function exportReport() {
    const reportType = document.querySelector('input[name="reportType"]:checked').value;
    const today = new Date().toISOString().split('T')[0];
    
    let csv = 'Report Type: ' + reportType.toUpperCase() + '\n';
    csv += 'Generated: ' + new Date().toLocaleString() + '\n\n';
    csv += 'Summary\n';
    csv += 'Today Sales,' + document.getElementById('todaySales').textContent + '\n';
    csv += 'Monthly Sales,' + document.getElementById('monthlySales').textContent + '\n';
    csv += 'Transactions Today,' + document.getElementById('todayTransactions').textContent + '\n';
    csv += 'Total Products,' + document.getElementById('totalProducts').textContent + '\n';
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `sales_report_${reportType}_${today}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>
{% endblock %}
