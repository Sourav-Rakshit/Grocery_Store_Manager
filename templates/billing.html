{% extends "base.html" %}

{% block title %}Billing - Grocery Store Management{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2 class="mb-4"><i class="fas fa-cash-register me-2"></i>Billing / POS System</h2>
    </div>
</div>

<div class="row g-4">
    <!-- Product Search and Cart -->
    <div class="col-lg-8">
        <!-- Customer Selection -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 align-items-center">
                    <div class="col-md-6">
                        <label class="form-label">Select Customer</label>
                        <select class="form-select" id="customerSelect">
                            <option value="">Walk-in Customer</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#newCustomerModal">
                            <i class="fas fa-plus me-1"></i> New Customer
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Search -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control" id="productSearch" placeholder="Search products by name or barcode...">
                </div>
                <div id="searchResults" class="list-group mt-2" style="max-height: 300px; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- Cart -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-shopping-cart me-2"></i>Cart</h5>
                <button class="btn btn-sm btn-outline-danger" id="clearCart">Clear Cart</button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table" id="cartTable">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Total</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr><td colspan="5" class="text-center text-muted">Cart is empty</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Billing Summary -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calculator me-2"></i>Bill Summary</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Subtotal</label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="text" class="form-control" id="subtotal" value="0.00" readonly>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Discount (%)</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="discountPercent" value="0" min="0" max="100">
                        <button class="btn btn-outline-secondary" id="applyDiscount">Apply</button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Discount Amount</label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="text" class="form-control" id="discountAmount" value="0.00" readonly>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tax (%)</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="taxPercent" value="0" min="0" max="30">
                        <button class="btn btn-outline-secondary" id="applyTax">Apply</button>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Tax Amount</label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="text" class="form-control" id="taxAmount" value="0.00" readonly>
                    </div>
                </div>
                <hr>
                <div class="mb-3">
                    <label class="form-label fw-bold">Total</label>
                    <div class="input-group">
                        <span class="input-group-text">₹</span>
                        <input type="text" class="form-control fw-bold" id="totalAmount" value="0.00" readonly>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Payment Method</label>
                    <select class="form-select" id="paymentMethod">
                        <option value="Cash">Cash</option>
                        <option value="UPI">UPI</option>
                        <option value="Card">Card</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Notes</label>
                    <textarea class="form-control" id="billNotes" rows="2" placeholder="Optional notes..."></textarea>
                </div>
                <button class="btn btn-success btn-lg w-100" id="completeSale">
                    <i class="fas fa-check-circle me-1"></i> Complete Sale
                </button>
            </div>
        </div>
    </div>
</div>

<!-- New Customer Modal -->
<div class="modal fade" id="newCustomerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Customer</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="newCustomerForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Name *</label>
                        <input type="text" class="form-control" id="customerName" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone *</label>
                        <input type="tel" class="form-control" id="customerPhone" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="customerEmail">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Address</label>
                        <textarea class="form-control" id="customerAddress" rows="2"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Customer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Invoice Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="invoiceContent">
                <!-- Invoice content will be generated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="window.print()">
                    <i class="fas fa-print me-1"></i> Print
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let cart = [];
let customers = [];

document.addEventListener('DOMContentLoaded', function() {
    loadCustomers();
    
    document.getElementById('productSearch').addEventListener('input', debounce(searchProducts, 300));
    document.getElementById('clearCart').addEventListener('click', clearCart);
    document.getElementById('applyDiscount').addEventListener('click', calculateTotals);
    document.getElementById('applyTax').addEventListener('click', calculateTotals);
    document.getElementById('completeSale').addEventListener('click', completeSale);
    document.getElementById('newCustomerForm').addEventListener('submit', addNewCustomer);
});

async function loadCustomers() {
    try {
        const response = await fetch('/api/customers');
        customers = await response.json();
        
        const options = customers.map(c => 
            `<option value="${c.customer_id}">${c.customer_name} - ${c.phone}</option>`
        ).join('');
        document.getElementById('customerSelect').innerHTML = '<option value="">Walk-in Customer</option>' + options;
    } catch (error) {
        console.error('Error loading customers:', error);
    }
}

async function searchProducts() {
    const query = document.getElementById('productSearch').value;
    const resultsDiv = document.getElementById('searchResults');
    
    if (query.length < 2) {
        resultsDiv.innerHTML = '';
        return;
    }
    
    try {
        const response = await fetch(`/api/products/search?q=${encodeURIComponent(query)}`);
        const products = await response.json();
        
        if (products.length === 0) {
            resultsDiv.innerHTML = '<div class="list-group-item text-muted">No products found</div>';
            return;
        }
        
        resultsDiv.innerHTML = products.map(p => `
            <button class="list-group-item list-group-item-action" onclick="addToCart(${p.product_id}, '${p.product_name}', ${p.price}, ${p.quantity})">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${p.product_name}</strong>
                        <br><small class="text-muted">${p.barcode || 'No barcode'}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-primary">₹${parseFloat(p.price).toFixed(2)}</span>
                        <br><small class="text-${p.quantity < 10 ? 'danger' : 'success'}">Stock: ${p.quantity}</small>
                    </div>
                </div>
            </button>
        `).join('');
    } catch (error) {
        console.error('Error searching products:', error);
    }
}

function addToCart(productId, productName, price, availableStock) {
    const existingItem = cart.find(item => item.product_id === productId);
    
    if (existingItem) {
        if (existingItem.quantity < availableStock) {
            existingItem.quantity++;
            existingItem.total_price = existingItem.quantity * existingItem.price;
        } else {
            showToast('Maximum stock reached', 'warning');
            return;
        }
    } else {
        cart.push({
            product_id: productId,
            product_name: productName,
            price: price,
            quantity: 1,
            total_price: price
        });
    }
    
    document.getElementById('searchResults').innerHTML = '';
    document.getElementById('productSearch').value = '';
    renderCart();
    calculateTotals();
}

function renderCart() {
    const tbody = document.querySelector('#cartTable tbody');
    
    if (cart.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">Cart is empty</td></tr>';
        return;
    }
    
    tbody.innerHTML = cart.map((item, index) => `
        <tr>
            <td>${item.product_name}</td>
            <td>₹${item.price.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, -1)">-</button>
                <span class="mx-2">${item.quantity}</span>
                <button class="btn btn-sm btn-outline-secondary" onclick="updateQuantity(${index}, 1)">+</button>
            </td>
            <td>₹${item.total_price.toFixed(2)}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="removeFromCart(${index})">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function updateQuantity(index, change) {
    cart[index].quantity += change;
    if (cart[index].quantity <= 0) {
        cart.splice(index, 1);
    } else {
        cart[index].total_price = cart[index].quantity * cart[index].price;
    }
    renderCart();
    calculateTotals();
}

function removeFromCart(index) {
    cart.splice(index, 1);
    renderCart();
    calculateTotals();
}

function clearCart() {
    cart = [];
    renderCart();
    calculateTotals();
    document.getElementById('customerSelect').value = '';
}

function calculateTotals() {
    const subtotal = cart.reduce((sum, item) => sum + item.total_price, 0);
    const discountPercent = parseFloat(document.getElementById('discountPercent').value) || 0;
    const discountAmount = subtotal * (discountPercent / 100);
    const afterDiscount = subtotal - discountAmount;
    const taxPercent = parseFloat(document.getElementById('taxPercent').value) || 0;
    const taxAmount = afterDiscount * (taxPercent / 100);
    const total = afterDiscount + taxAmount;
    
    document.getElementById('subtotal').value = subtotal.toFixed(2);
    document.getElementById('discountAmount').value = discountAmount.toFixed(2);
    document.getElementById('taxAmount').value = taxAmount.toFixed(2);
    document.getElementById('totalAmount').value = total.toFixed(2);
}

async function completeSale() {
    if (cart.length === 0) {
        showToast('Cart is empty', 'warning');
        return;
    }
    
    const saleData = {
        customer_id: document.getElementById('customerSelect').value || null,
        items: cart,
        subtotal: parseFloat(document.getElementById('subtotal').value),
        discount_amount: parseFloat(document.getElementById('discountAmount').value),
        tax_amount: parseFloat(document.getElementById('taxAmount').value),
        total_amount: parseFloat(document.getElementById('totalAmount').value),
        payment_method: document.getElementById('paymentMethod').value,
        notes: document.getElementById('billNotes').value
    };
    
    try {
        const response = await fetch('/api/sales', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(saleData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showInvoice(data.invoice_number, saleData);
            clearCart();
            resetBillForm();
            showToast('Sale completed successfully!', 'success');
        } else {
            showToast(data.error || 'Error completing sale', 'error');
        }
    } catch (error) {
        showToast('Error completing sale', 'error');
    }
}

function showInvoice(invoiceNumber, saleData) {
    const invoiceContent = document.getElementById('invoiceContent');
    
    let itemsHtml = saleData.items.map(item => `
        <tr>
            <td>${item.product_name}</td>
            <td>${item.quantity}</td>
            <td>₹${item.price.toFixed(2)}</td>
            <td>₹${item.total_price.toFixed(2)}</td>
        </tr>
    `).join('');
    
    invoiceContent.innerHTML = `
        <div class="invoice">
            <h4 class="text-center mb-4">Grocery Store</h4>
            <p class="text-center text-muted">Invoice: ${invoiceNumber}</p>
            <p class="text-center text-muted">Date: ${new Date().toLocaleString()}</p>
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Total</th>
                    </tr>
                </thead>
                <tbody>
                    ${itemsHtml}
                </tbody>
            </table>
            <div class="text-end">
                <p>Subtotal: ₹${saleData.subtotal.toFixed(2)}</p>
                <p>Discount: -₹${saleData.discount_amount.toFixed(2)}</p>
                <p>Tax: ₹${saleData.tax_amount.toFixed(2)}</p>
                <h4>Total: ₹${saleData.total_amount.toFixed(2)}</h4>
                <p class="text-muted">Payment: ${saleData.payment_method}</p>
            </div>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('invoiceModal')).show();
}

function resetBillForm() {
    document.getElementById('discountPercent').value = 0;
    document.getElementById('taxPercent').value = 0;
    document.getElementById('paymentMethod').value = 'Cash';
    document.getElementById('billNotes').value = '';
    calculateTotals();
}

async function addNewCustomer(e) {
    e.preventDefault();
    
    const customerData = {
        customer_name: document.getElementById('customerName').value,
        phone: document.getElementById('customerPhone').value,
        email: document.getElementById('customerEmail').value,
        address: document.getElementById('customerAddress').value
    };
    
    try {
        const response = await fetch('/api/customers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(customerData)
        });
        
        const data = await response.json();
        
        if (response.ok) {
            bootstrap.Modal.getInstance(document.getElementById('newCustomerModal')).hide();
            document.getElementById('newCustomerForm').reset();
            loadCustomers();
            showToast('Customer added successfully', 'success');
        } else {
            showToast(data.error || 'Error adding customer', 'error');
        }
    } catch (error) {
        showToast('Error adding customer', 'error');
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${type === 'success' ? 'success' : type === 'error' ? 'danger' : type === 'warning' ? 'warning text-dark' : 'info'} border-0`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">${message}</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
    `;
    
    const container = document.createElement('div');
    container.className = 'toast-container position-fixed top-0 end-0 p-3';
    container.appendChild(toast);
    document.body.appendChild(container);
    
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
    
    toast.addEventListener('hidden.bs.toast', () => container.remove());
}
</script>
{% endblock %}
